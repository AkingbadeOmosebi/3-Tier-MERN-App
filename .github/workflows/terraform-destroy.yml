name: Terraform Infrastructure Destroy

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      confirmation:
        description: 'Type "destroy" to confirm infrastructure destruction' # confirmation input
        required: true
        type: string
      modules:
        description: 'Modules to destroy (comma-separated or "all")'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - cosmos-db
          - aks-cluster
          - core-infra
          - networking

permissions:    # required permissions for the workflow
  id-token: write
  contents: read
  issues: write

jobs: 
  validate-input:
    name: Validate Destruction Request 
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Check confirmation input
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "destroy" ]; then
            echo "Invalid confirmation. You must type 'destroy' exactly."
            exit 1
          fi
          echo "Confirmation validated. Proceeding with infrastructure destruction."

  destroy:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest
    needs: validate-input
    environment: production
    timeout-minutes: 90
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Destroy Cosmos DB
        if: contains(github.event.inputs.modules, 'all') || contains(github.event.inputs.modules, 'cosmos-db')
        working-directory: terraform/cosmos-db
        run: |
          terraform init
          terraform destroy -auto-approve
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_USE_OIDC: true
          TF_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Destroy AKS Cluster
        if: contains(github.event.inputs.modules, 'all') || contains(github.event.inputs.modules, 'aks-cluster')
        working-directory: terraform/aks-cluster
        run: |
          terraform init
          terraform destroy -auto-approve
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_USE_OIDC: true
          TF_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Destroy Networking
        if: contains(github.event.inputs.modules, 'all') || contains(github.event.inputs.modules, 'networking')
        working-directory: terraform/networking
        run: |
          terraform init
          terraform destroy -auto-approve
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_USE_OIDC: true
          TF_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Destroy Core Infrastructure
        if: contains(github.event.inputs.modules, 'all') || contains(github.event.inputs.modules, 'core-infra')
        working-directory: terraform/core-infra
        run: |
          terraform init
          terraform destroy -auto-approve
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_USE_OIDC: true
          TF_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  notify:
    name: Create Destruction Issue
    runs-on: ubuntu-latest
    needs: destroy
    if: always()
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create destruction status issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const destroyResult = '${{ needs.destroy.result }}';
            const timestamp = new Date().toISOString();
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const modules = '${{ github.event.inputs.modules }}';
            
            let title, body, labels;
            
            if (destroyResult === 'success') {
              title = `Infrastructure Destroyed - ${timestamp}`;
              body = `## Infrastructure Destruction Completed
              
              **Status:** Success
              **Triggered by:** @${{ github.actor }}
              **Workflow Run:** [View Details](${runUrl})
              **Modules Destroyed:** ${modules}
              
              ### Confirmation
              Destruction was confirmed with required input: "destroy"
              
              ### Resources Removed
              All resources in the specified modules have been permanently deleted from Azure.
              
              **WARNING:** This action cannot be undone.`;
              labels = ['destruction', 'success', 'infrastructure'];
            } else {
              title = `Infrastructure Destruction Failed - ${timestamp}`;
              body = `## Infrastructure Destruction Failed
              
              **Status:** Failed
              **Triggered by:** @${{ github.actor }}
              **Workflow Run:** [View Details](${runUrl})
              **Target Modules:** ${modules}
              
              ### Action Required
              The destruction process encountered errors. Please review the logs.
              
              ### Possible Issues
              - Resources may have dependencies preventing deletion
              - State lock conflicts
              - Permission issues
              - Resources in use by other services
              
              cc: @${{ github.actor }}`;
              labels = ['destruction', 'failure', 'infrastructure', 'urgent'];
            }
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: labels
            });