name: DevSecOps Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Manual trigger

permissions:
  contents: read
  security-events: write  # For security scanning
  id-token: write        # For OIDC

jobs:
  security-scans:
    name: Code Security Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for GitLeaks
      
      # ============================================
      # GITLEAKS - Secret Detection
      # ============================================
      - name: GitLeaks Secret Scanning
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ============================================
      # SonarCloud - SAST & Code Quality
      # ============================================
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=AkingbadeOmosebi_3-Tier-MERN-App
            -Dsonar.organization=akingbadeomosebi

      # ============================================
      # OWASP Dependency-Check - Dependency Scanning
      # ============================================
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: OWASP Dependency-Check
        continue-on-error: true
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: '3-Tier-MERN-App'
          path: '.'
          format: 'HTML'
          args: >
            --failOnCVSS 7
            --enableRetired
      
      - name: Upload OWASP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: owasp-dependency-check-report
          path: reports/
  
  semantic-release:
    name: Semantic Release & Versioning
    runs-on: ubuntu-latest
    needs: security-scans  # Only run if security passes
    outputs:
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for semantic-release
          token: ${{ secrets.GITHUB_TOKEN }}  # Use GitHub's built-in token
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          branches: |
            [
              'main',
              'develop'
            ]
          extra_plugins: |
            @semantic-release/changelog@6.0.0
            @semantic-release/git@10.0.0

  build-and-scan:
    name: Build & Container Security
    runs-on: ubuntu-latest
    needs: semantic-release  # ← CHANGED: Now depends on semantic-release
    if: needs.semantic-release.outputs.new_release_published == 'true'  # ← Only build if new release
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # ============================================
      # Hadolint - Dockerfile Linting
      # ============================================
      - name: Hadolint - Backend Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: MERN-APP/backend/Dockerfile
          failure-threshold: error
      
      - name: Hadolint - Frontend Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: MERN-APP/frontend/Dockerfile
          failure-threshold: error
      
      # ============================================
      # Docker Build with Semantic Version
      # ============================================
      - name: Build Backend Image
        run: |
          docker build \
            -t acr3tiermernappao.azurecr.io/backend:v${{ needs.semantic-release.outputs.new_release_version }} \
            -t acr3tiermernappao.azurecr.io/backend:latest \
            -f MERN-APP/backend/Dockerfile \
            MERN-APP/backend
      
      - name: Build Frontend Image
        run: |
          docker build \
            -t acr3tiermernappao.azurecr.io/frontend:v${{ needs.semantic-release.outputs.new_release_version }} \
            -t acr3tiermernappao.azurecr.io/frontend:latest \
            -f MERN-APP/frontend/Dockerfile \
            MERN-APP/frontend

      # ============================================
      # Trivy - Container Vulnerability Scanning
      # ============================================
      - name: Run Trivy - Backend Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'acr3tiermernappao.azurecr.io/backend:v${{ needs.semantic-release.outputs.new_release_version }}'
          format: 'sarif'
          output: 'trivy-backend-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail pipeline on CRITICAL/HIGH vulnerabilities
      
      - name: Run Trivy - Frontend Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'acr3tiermernappao.azurecr.io/frontend:v${{ needs.semantic-release.outputs.new_release_version }}'
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail pipeline on CRITICAL/HIGH vulnerabilities
      
      - name: Upload Trivy Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: '.'
          category: 'trivy-container-scan'


  push-to-acr:
    name: Push Images to Azure Container Registry
    runs-on: ubuntu-latest
    needs: [semantic-release, build-and-scan]  # Needs both version and built images
    if: needs.semantic-release.outputs.new_release_published == 'true'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # ============================================
      # Azure Login via OIDC
      # ============================================
      - name: Azure Login using OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      # ============================================
      # ACR Login
      # ============================================
      - name: Login to Azure Container Registry
        run: |
          az acr login --name acr3TierMernAppAO
      
      # ============================================
      # Rebuild & Push Images (with version tags)
      # ============================================
      - name: Build & Push Backend Image
        run: |
          docker build \
            -t acr3tiermernappao.azurecr.io/backend:v${{ needs.semantic-release.outputs.new_release_version }} \
            -t acr3tiermernappao.azurecr.io/backend:latest \
            -f MERN-APP/backend/Dockerfile \
            MERN-APP/backend
          
          docker push acr3tiermernappao.azurecr.io/backend:v${{ needs.semantic-release.outputs.new_release_version }}
          docker push acr3tiermernappao.azurecr.io/backend:latest
      
      - name: Build & Push Frontend Image
        run: |
          docker build \
            -t acr3tiermernappao.azurecr.io/frontend:v${{ needs.semantic-release.outputs.new_release_version }} \
            -t acr3tiermernappao.azurecr.io/frontend:latest \
            -f MERN-APP/frontend/Dockerfile \
            MERN-APP/frontend
          
          docker push acr3tiermernappao.azurecr.io/frontend:v${{ needs.semantic-release.outputs.new_release_version }}
          docker push acr3tiermernappao.azurecr.io/frontend:latest
      
      # ============================================
      # Logout
      # ============================================
      - name: Azure Logout
        run: az logout
        if: always()