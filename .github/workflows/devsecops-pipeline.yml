name: DevSecOps Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_run:
    workflows: ["Terraform Infrastructure Deployment"]
    types:
      - completed
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write 
  security-events: write  # For security scanning
  id-token: write        # For OIDC permissions

jobs:
  check-infrastructure:
    name: Verify Infrastructure Deployment
    runs-on: ubuntu-latest
    outputs:
      infra_ready: ${{ steps.check.outputs.ready }}
    steps:
    - name: Check if infrastructure deployment succeeded
      id: check
      run: |
        if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
          echo "ready=true" >> $GITHUB_OUTPUT
          echo "Infrastructure deployment succeeded, proceeding with DevSecOps pipeline"
        else
          echo "ready=false" >> $GITHUB_OUTPUT
          echo "Infrastructure deployment failed or was cancelled, skipping DevSecOps pipeline"
          exit 1
        fi

  security-scans:
    timeout-minutes: 30
    name: Code Security Scanning
    runs-on: ubuntu-latest
    needs: [check-infrastructure]
    if: |
      always() &&
      (needs.check-infrastructure.result == 'skipped' || needs.check-infrastructure.outputs.infra_ready == 'true')
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for GitLeaks
      
      # ============================================
      # GITLEAKS - Secret Detection
      # ============================================
      - name: GitLeaks Secret Scanning
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ============================================
      # SonarCloud - SAST & Code Quality
      # ============================================
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=AkingbadeOmosebi_3-Tier-MERN-App
            -Dsonar.organization=akingbadeomosebi

      # ============================================
      # OWASP Dependency-Check - Dependency Scanning
      # ============================================
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
        
      # Cache OWASP database
      - name: Cache OWASP DB
        uses: actions/cache@v4
        with:
          path: ~/.gradle/dependency-check-data
          key: ${{ runner.os }}-owasp-${{ hashFiles('**/package-lock.json') }}
      
      - name: OWASP Dependency-Check
        continue-on-error: true  # Allow pipeline to continue even if vulnerabilities found, Report But Don't Fail. 
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: '3-Tier-MERN-App'
          path: '.'
          format: 'HTML'
          args: >
            --failOnCVSS 7
            --enableRetired
      
      - name: Upload OWASP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: owasp-dependency-check-report
          path: reports/
  
  semantic-release:
    timeout-minutes: 10
    name: Semantic Release & Versioning
    runs-on: ubuntu-latest
    needs: [check-infrastructure, security-scans]
    if: needs.check-infrastructure.outputs.infra_ready == 'true'
    permissions:  # Job-level override
      contents: write
      issues: write
      pull-requests: write
    outputs:
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}    

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for semantic-release
          token: ${{ secrets.GITHUB_TOKEN }}  # Use GitHub's built-in token
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          branches: |
            [
              'main',
              'develop'
            ]
          extra_plugins: |
            @semantic-release/changelog@6.0.0
            @semantic-release/git@10.0.0
            conventional-changelog-conventionalcommits@8.0.0 

  build-and-scan:
    timeout-minutes: 45
    name: Build & Container Security
    runs-on: ubuntu-latest
    needs: [check-infrastructure, semantic-release]
    if: |
      needs.check-infrastructure.outputs.infra_ready == 'true' &&
      needs.semantic-release.outputs.new_release_published == 'true'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # ============================================
      # Hadolint - Dockerfile Linting
      # ============================================
      - name: Hadolint - Backend Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: MERN-APP/backend/Dockerfile
          failure-threshold: error
      
      - name: Hadolint - Frontend Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: MERN-APP/frontend/Dockerfile
          failure-threshold: error
      
      # ============================================
      # Docker Build with Semantic Version
      # ============================================
      - name: Build Backend Image
        run: |
          docker build \
            -t acr3tiermernappao.azurecr.io/backend:v${{ needs.semantic-release.outputs.new_release_version }} \
            -t acr3tiermernappao.azurecr.io/backend:latest \
            -f MERN-APP/backend/Dockerfile \
            MERN-APP/backend
      
      - name: Build Frontend Image
        run: |
          docker build \
            -t acr3tiermernappao.azurecr.io/frontend:v${{ needs.semantic-release.outputs.new_release_version }} \
            -t acr3tiermernappao.azurecr.io/frontend:latest \
            -f MERN-APP/frontend/Dockerfile \
            MERN-APP/frontend
    
      # ============================================
      # SBOM Generation - Software Bill of Materials
      # ============================================
      - name: Generate SBOM for Backend
        uses: anchore/sbom-action@v0
        with:
          image: acr3tiermernappao.azurecr.io/backend:v${{ needs.semantic-release.outputs.new_release_version }}
          format: cyclonedx-json
          output-file: sbom-backend.cyclonedx.json
      
      - name: Generate SBOM for Frontend
        uses: anchore/sbom-action@v0
        with:
          image: acr3tiermernappao.azurecr.io/frontend:v${{ needs.semantic-release.outputs.new_release_version }}
          format: cyclonedx-json
          output-file: sbom-frontend.cyclonedx.json
      
      - name: Upload SBOM Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sbom-reports
          path: |
            sbom-backend.cyclonedx.json
            sbom-frontend.cyclonedx.json
    
      # ============================================
      # Trivy - Container Vulnerability Scanning
      # ============================================
      - name: Run Trivy - Backend Image
        continue-on-error: true # Allow pipeline to continue even if vulnerabilities found, Application Level issue, Report But Don't Fail.
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'acr3tiermernappao.azurecr.io/backend:v${{ needs.semantic-release.outputs.new_release_version }}'
          format: 'sarif'
          output: 'trivy-backend-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail pipeline on CRITICAL/HIGH vulnerabilities
      
      - name: Run Trivy - Frontend Image
        continue-on-error: true # Allow pipeline to continue even if vulnerabilities found, Application Level issue, Report But Don't Fail.
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'acr3tiermernappao.azurecr.io/frontend:v${{ needs.semantic-release.outputs.new_release_version }}'
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail pipeline on CRITICAL/HIGH vulnerabilities
      
      - name: Upload Trivy Backend Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4  # Updated to v4
        if: always()
        with:
          sarif_file: 'trivy-backend-results.sarif'
          category: 'trivy-backend-scan'
      
      - name: Upload Trivy Frontend Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4  # Updated to v4
        if: always()
        with:
          sarif_file: 'trivy-frontend-results.sarif'
          category: 'trivy-frontend-scan'

  push-to-acr:
    timeout-minutes: 30
    name: Push Images to Azure Container Registry
    runs-on: ubuntu-latest
    needs: [check-infrastructure, semantic-release, build-and-scan]
    if: |
      needs.check-infrastructure.outputs.infra_ready == 'true' &&
      needs.semantic-release.outputs.new_release_published == 'true'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # ============================================
      # Azure Login via OIDC
      # ============================================
      - name: Azure Login using OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      # ============================================
      # ACR Login
      # ============================================
      - name: Login to Azure Container Registry
        run: |
          az acr login --name acr3TierMernAppAO
      
      # ============================================
      # Rebuild & Push Images (with version tags)
      # ============================================
      - name: Build & Push Backend Image   # Build time: 2 min Ã— 2 jobs = 4 minutes. Whereas Artifact storage Costs money (storage fees), Artifact downloads can be slower than rebuild (for large images) The complexity of artifact management (save/upload/download/load) adds failure points without significant time savings. In production, this will be evaluated or discussed, but not for this my personal project.
        run: |
          docker build \
            -t acr3tiermernappao.azurecr.io/backend:v${{ needs.semantic-release.outputs.new_release_version }} \
            -t acr3tiermernappao.azurecr.io/backend:latest \
            -f MERN-APP/backend/Dockerfile \
            MERN-APP/backend
          
          docker push acr3tiermernappao.azurecr.io/backend:v${{ needs.semantic-release.outputs.new_release_version }}
          docker push acr3tiermernappao.azurecr.io/backend:latest
      
      - name: Build & Push Frontend Image  # Same as above note...
        run: |
          docker build \
            -t acr3tiermernappao.azurecr.io/frontend:v${{ needs.semantic-release.outputs.new_release_version }} \
            -t acr3tiermernappao.azurecr.io/frontend:latest \
            -f MERN-APP/frontend/Dockerfile \
            MERN-APP/frontend
          
          docker push acr3tiermernappao.azurecr.io/frontend:v${{ needs.semantic-release.outputs.new_release_version }}
          docker push acr3tiermernappao.azurecr.io/frontend:latest
      
      # ============================================
      # Image Signing with Cosign (Supply Chain Security)
      # ============================================
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
      
      - name: Sign Backend Image
        run: |
          cosign sign --yes \
            acr3tiermernappao.azurecr.io/backend:v${{ needs.semantic-release.outputs.new_release_version }}
      
      - name: Sign Frontend Image
        run: |
          cosign sign --yes \
            acr3tiermernappao.azurecr.io/frontend:v${{ needs.semantic-release.outputs.new_release_version }}

      # ============================================
      # Logout
      # ============================================
      - name: Azure Logout
        run: az logout
        if: always()

  notify-results:
    timeout-minutes: 5
    name: Notify Pipeline Results
    permissions:
      issues: write
    runs-on: ubuntu-latest
    needs: [check-infrastructure, security-scans, semantic-release, build-and-scan, push-to-acr]
    if: always()
    
    steps:
      - name: Create Success Issue
        if: needs.push-to-acr.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.semantic-release.outputs.new_release_version }}';
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `DevSecOps Pipeline Success - v${version}`,
              body: `## Pipeline Completed Successfully
            
            **Version:** v${version}
            **Workflow Run:** ${runUrl}
            **Triggered by:** ${{ github.actor }}
            **Commit:** ${{ github.sha }}
            
            ### Deliverables
            - Backend image pushed to ACR
            - Frontend image pushed to ACR
            - Images signed with Cosign
            - SBOM generated
            
            ### Security Checks
            - GitLeaks: No secrets detected
            - OWASP Dependency-Check: Scanned
            - SonarCloud: Quality gate passed
            - Hadolint: Dockerfiles validated
            - Trivy: Container vulnerabilities reported
            
            ### Image Tags
            \`\`\`
            acr3tiermernappao.azurecr.io/backend:v${version}
            acr3tiermernappao.azurecr.io/frontend:v${version}
            \`\`\`
            
            ---
            *This issue was automatically created by the DevSecOps pipeline.*`,
              labels: ['pipeline-success', 'automated']
            });
      
      - name: Create No Release Issue
        if: needs.push-to-acr.result == 'skipped'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `DevSecOps Pipeline - No Release Required`,
              body: `## No New Release Published
            
            **Workflow Run:** ${runUrl}
            **Triggered by:** ${{ github.actor }}
            **Commit:** ${{ github.sha }}
            
            ### Summary
            No new version was published because no conventional commits were detected that trigger a release.
            
            ### Security Checks Completed
            - GitLeaks: Executed
            - OWASP Dependency-Check: Executed
            - SonarCloud: Executed
            
            ### Next Steps
            - No action required
            - Build and push jobs were skipped as no new release was needed
            
            ---
            *This issue was automatically created by the DevSecOps pipeline.*`,
              labels: ['pipeline-skipped', 'automated']
            });
      
      - name: Create Failure Issue
        if: |
          needs.security-scans.result == 'failure' ||
          needs.semantic-release.result == 'failure' ||
          needs.build-and-scan.result == 'failure' ||
          needs.push-to-acr.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const failedJob = '${{ needs.security-scans.result }}' === 'failure' ? 'Security Scans' :
                              '${{ needs.semantic-release.result }}' === 'failure' ? 'Semantic Release' :
                              '${{ needs.build-and-scan.result }}' === 'failure' ? 'Build & Scan' :
                              '${{ needs.push-to-acr.result }}' === 'failure' ? 'Push to ACR' : 'Unknown';
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `DevSecOps Pipeline Failed - ${failedJob}`,
              body: `## Pipeline Failure Alert
            
            **Failed Job:** ${failedJob}
            **Workflow Run:** ${runUrl}
            **Triggered by:** ${{ github.actor }}
            **Commit:** ${{ github.sha }}
            
            ### Job Status
            - Security Scans: ${{ needs.security-scans.result }}
            - Semantic Release: ${{ needs.semantic-release.result }}
            - Build & Scan: ${{ needs.build-and-scan.result }}
            - Push to ACR: ${{ needs.push-to-acr.result }}
            
            ### Action Required
            Please review the workflow logs and address the failure before the next deployment.
            
            ---
            *This issue was automatically created by the DevSecOps pipeline.*`,
              labels: ['pipeline-failure', 'automated', 'urgent']
            });